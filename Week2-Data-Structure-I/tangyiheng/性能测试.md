# 性能测试

## 布隆过滤器

初始化一个布隆过滤器：

- 位图长度为 $2^{18}$
- 3 个哈希函数分别为`fnv.New64()`，`fnv.New64a()`，`murmur3.New64()`）。

### 插入

将不同整数转换为字符串，然后插入到布隆过滤器，重复若干次。

```go
func BenchmarkSet(b *testing.B) {
	bf := New()
	buf := make([]byte, 4)
	for i := 0; i < b.N; i++ {
		intToByte(buf, i)
		bf.Set(buf)
	}
}
```

测试结果：

插入次数为 10194825，每次插入操作耗时 113.8 ns，分配 3 次内存（共 56 bytes），总运行时间为 5.958 s。

```bash
(base) ➜  bloom-filter go test -bench=BenchmarkSet -benchmem   
goos: darwin
goarch: arm64
pkg: data-structure/bloom-filter
BenchmarkSet-8          10194825               113.8 ns/op            56 B/op          3 allocs/op
PASS
ok      data-structure/bloom-filter     5.958s
```

### 查询

将不同整数转换为字符串，然后查询布隆过滤器，重复若干次	

```go
func BenchmarkGet(b *testing.B) {
	bf := New()
	buf := make([]byte, 4)
	for i := 0; i < b.N; i++ {
		intToByte(buf, i)
		bf.Get(buf)
	}
}
```

测试结果：

插入次数为 9676186，每次查询操作耗时 108.9 ns，分配 3 次内存（共 56 bytes），总运行时间为 4.766 s。

```bash
(base) ➜  bloom-filter go test -bench=BenchmarkGet -benchmem
goos: darwin
goarch: arm64
pkg: data-structure/bloom-filter
BenchmarkGet-8           9676186               108.9 ns/op            56 B/op          3 allocs/op
PASS
ok      data-structure/bloom-filter     4.766s
```

## 布谷鸟过滤器

初始化一个布谷鸟过滤器：

- 桶数组长度为 $2^{16}$
- 桶大小为 4 bytes
- 指纹大小为 3 bit
- 最大”踢出“次数为 500（用于解决挤兑循环问题）
- 2个哈希函数为 `murmur3.New64`

### 插入

将不同整数转换为字符串，然后插入到布谷鸟过滤器，重复若干次。

```go
func BenchmarkInsert(b *testing.B) {
	cf := New()
	buf := make([]byte, 4)
	for i := 0; i < b.N; i++ {
		intToByte(buf, i)
		cf.Insert(buf)
	}
}
```

测试结果：

查询次数为 1000000，每次插入操作耗时 59878 ns，分配 373 次内存（共 35685 bytes），总运行时间为 62.990s。

```bash
(base) ➜  cuckoo-filter go test -bench=BenchmarkInsert -benchmem                               
goos: darwin
goarch: arm64
pkg: data-structure/cuckoo-filter
BenchmarkInsert-8        1000000             59878 ns/op           35685 B/op        373 allocs/op
PASS
ok      data-structure/cuckoo-filter    62.990s
```

### 查询

将不同整数转换为字符串，然后查询布谷鸟过滤器，重复若干次。

```go
func BenchmarkLookup(b *testing.B) {
	cf := New()
	buf := make([]byte, 4)
	for i := 0; i < b.N; i++ {
		intToByte(buf, i)
		cf.Lookup(buf)
	}
}
```

测试结果：

查询次数为 5128374，每次查询操作耗时 240.4 ns，分配 4 次内存（共 209 bytes），总运行时间为 1.619 s。

```bash
(base) ➜  cuckoo-filter go test -bench=BenchmarkLookup -benchmem
goos: darwin
goarch: arm64
pkg: data-structure/cuckoo-filter
BenchmarkLookup-8        5128374               240.4 ns/op           209 B/op          4 allocs/op
PASS
ok      data-structure/cuckoo-filter    1.619s
```

### 删除

将不同整数转换为字符串，然后在布谷鸟过滤器执行删除操作，重复若干次。

```go
func BenchmarkDelete(b *testing.B) {
	buf := make([]byte, 4)
	for i := 0; i < b.N; i++ {
		intToByte(buf, i)
		cf.Delete(buf)
	}
}
```

测试结果：

查询次数为 4366633，每次查询操作耗时 279.0 ns，分配 4 次内存（共 208 bytes）。

```go
(base) ➜  cuckoo-filter go test -bench=. -benchmem
goos: darwin
goarch: arm64
pkg: data-structure/cuckoo-filter
BenchmarkInsert-8        1000000             59557 ns/op           36163 B/op        378 allocs/op
BenchmarkLookup-8        4294449               263.6 ns/op           208 B/op          4 allocs/op
BenchmarkDelete-8        4366633               279.0 ns/op           208 B/op          4 allocs/op
PASS
ok      data-structure/cuckoo-filter    62.588s

```

## 遇到的问题

- 未做假阳性计算的性能测试。
- 布谷鸟过滤器性能测试结果较差，有待进一步优化。

